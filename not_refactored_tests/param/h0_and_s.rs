use tincr::param::h0_and_s::*;
use super::tests::*;


/// Test of H0 and S construction for a water molecule. The xyz geometry of the
/// water molecule is
/// ```no_run
/// 3
//
// O          0.34215        1.17577        0.00000
// H          1.31215        1.17577        0.00000
// H          0.01882        1.65996        0.77583
///```
///
///
#[test]
fn test_h0_and_s() {
    let mol: Molecule = get_water_molecule();
    let mut positions: Array2<f64> = array![
        [0.34215, 1.17577, 0.00000],
        [1.31215, 1.17577, 0.00000],
        [0.01882, 1.65996, 0.77583]
    ];
    // transform coordinates in au
    positions = positions / 0.529177249;
    let atomic_numbers: Vec<u8> = vec![8, 1, 1];
    let (s, h0): (Array2<f64>, Array2<f64>) = h0_and_s(
        &atomic_numbers,
        positions.view(),
        mol.calculator.n_orbs,
        &mol.calculator.valorbs,
        mol.proximity_matrix.view(),
        &mol.calculator.skt,
        &mol.calculator.orbital_energies,
    );
    let h0_ref: Array2<f64> = array![
        [
            -0.8469280666780000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.4001900137965521,
            -0.4001924355118327
        ],
        [
            0.0000000000000000,
            -0.3147840652470000,
            0.0000000000000000,
            0.0000000000000000,
            -0.0000000000000000,
            0.1843837827225484
        ],
        [
            0.0000000000000000,
            0.0000000000000000,
            -0.3147840652470000,
            0.0000000000000000,
            -0.0000000000000000,
            0.2954428429947638
        ],
        [
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.3147840652470000,
            0.3693816741249312,
            -0.1231268891709485
        ],
        [
            -0.4001900137965521,
            -0.0000000000000000,
            -0.0000000000000000,
            0.3693816741249312,
            -0.2180797689420000,
            -0.0538731538940353
        ],
        [
            -0.4001924355118327,
            0.1843837827225484,
            0.2954428429947638,
            -0.1231268891709485,
            -0.0538731538940353,
            -0.2180797689420000
        ]
    ];
    let s_ref: Array2<f64> = array![
        [
            1.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.3074918525690681,
            0.3074937992389065
        ],
        [
            0.0000000000000000,
            1.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.1987769748092704
        ],
        [
            0.0000000000000000,
            0.0000000000000000,
            1.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.3185054221819456
        ],
        [
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            1.0000000000000000,
            -0.3982160222204482,
            0.1327383036929333
        ],
        [
            0.3074918525690681,
            0.0000000000000000,
            0.0000000000000000,
            -0.3982160222204482,
            1.0000000000000000,
            0.0268024699984349
        ],
        [
            0.3074937992389065,
            -0.1987769748092704,
            -0.3185054221819456,
            0.1327383036929333,
            0.0268024699984349,
            1.0000000000000000
        ]
    ];
    assert!(s.abs_diff_eq(&s_ref, 1e-16));
    assert!(h0.abs_diff_eq(&h0_ref, 1e-16));
}

#[test]
fn test_grad_H0_andS() {
    let molecule: Molecule = get_water_molecule();

    let gradS_ref: Array3<f64> = array![
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.3590399304938401,
                -0.1196795358000320
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0918870323801337
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1472329381678249
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.3350012527450977,
                0.1558859507933732
            ],
            [
                0.3590399304938401,
                0.0000000000000000,
                0.0000000000000000,
                -0.3350012527450977,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                -0.1196795358000320,
                0.0918870323801337,
                0.1472329381678249,
                0.1558859507933732,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1792213355983593
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2172441846869481,
                0.0796440422386294
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2204828389926055
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0918870323801337
            ],
            [
                0.0000000000000000,
                0.2172441846869481,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.1792213355983593,
                0.0796440422386294,
                -0.2204828389926055,
                0.0918870323801337,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2871709221530289
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2204828389926055
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2172441846869481,
                -0.1360394644282639
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1472329381678249
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.2172441846869481,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.2871709221530289,
                -0.2204828389926055,
                -0.1360394644282639,
                0.1472329381678249,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.3590399304938401,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.3350012527450977,
                0.0000000000000000
            ],
            [
                -0.3590399304938401,
                0.0000000000000000,
                0.0000000000000000,
                0.3350012527450977,
                0.0000000000000000,
                -0.0493263812570877
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0493263812570877,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2172441846869481,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                -0.2172441846869481,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0184665480123938
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0184665480123938,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2172441846869481,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                -0.2172441846869481,
                0.0000000000000000,
                0.0000000000000000,
                0.0295894213933693
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0295894213933693,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1196795358000320
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0918870323801337
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1472329381678249
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1558859507933732
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0493263812570877
            ],
            [
                0.1196795358000320,
                -0.0918870323801337,
                -0.1472329381678249,
                -0.1558859507933732,
                0.0493263812570877,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1792213355983593
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0796440422386294
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2204828389926055
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0918870323801337
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0184665480123938
            ],
            [
                -0.1792213355983593,
                -0.0796440422386294,
                0.2204828389926055,
                -0.0918870323801337,
                -0.0184665480123938,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2871709221530289
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2204828389926055
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1360394644282639
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1472329381678249
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0295894213933693
            ],
            [
                -0.2871709221530289,
                0.2204828389926055,
                0.1360394644282639,
                -0.1472329381678249,
                -0.0295894213933693,
                0.0000000000000000
            ]
        ]
    ];

    let gradH0_ref: Array3<f64> = array![
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.4466562325187367,
                0.1488849546574482
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0859724600043996
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1377558678312508
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.3151837170301471,
                -0.1441050567093689
            ],
            [
                -0.4466562325187367,
                0.0000000000000000,
                0.0000000000000000,
                0.3151837170301471,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.1488849546574482,
                -0.0859724600043996,
                -0.1377558678312508,
                -0.1441050567093689,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2229567506745117
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2015137919014903,
                -0.0727706772643434
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2062908287050795
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0859724600043996
            ],
            [
                0.0000000000000000,
                -0.2015137919014903,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                -0.2229567506745117,
                -0.0727706772643434,
                0.2062908287050795,
                -0.0859724600043996,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.3572492944418646
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2062908287050795
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2015137919014903,
                0.1290297419048926
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1377558678312508
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                -0.2015137919014903,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                -0.3572492944418646,
                0.2062908287050795,
                0.1290297419048926,
                -0.1377558678312508,
                0.0000000000000000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.4466562325187367,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.3151837170301471,
                0.0000000000000000
            ],
            [
                0.4466562325187367,
                0.0000000000000000,
                0.0000000000000000,
                -0.3151837170301471,
                0.0000000000000000,
                0.0738575792762484
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0738575792762484,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2015137919014903,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.2015137919014903,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0276504073281890
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0276504073281890,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2015137919014903,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.2015137919014903,
                0.0000000000000000,
                0.0000000000000000,
                -0.0443049536699000
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0443049536699000,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1488849546574482
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0859724600043996
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1377558678312508
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1441050567093689
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.0738575792762484
            ],
            [
                -0.1488849546574482,
                0.0859724600043996,
                0.1377558678312508,
                0.1441050567093689,
                -0.0738575792762484,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.2229567506745117
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0727706772643434
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2062908287050795
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0859724600043996
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0276504073281890
            ],
            [
                0.2229567506745117,
                0.0727706772643434,
                -0.2062908287050795,
                0.0859724600043996,
                0.0276504073281890,
                0.0000000000000000
            ]
        ],
        [
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.3572492944418646
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.2062908287050795
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                -0.1290297419048926
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.1377558678312508
            ],
            [
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0000000000000000,
                0.0443049536699000
            ],
            [
                0.3572492944418646,
                -0.2062908287050795,
                -0.1290297419048926,
                0.1377558678312508,
                0.0443049536699000,
                0.0000000000000000
            ]
        ]
    ];

    let (grad_s, grad_h0): (Array3<f64>, Array3<f64>) = h0_and_s_gradients(
        &molecule.atomic_numbers,
        molecule.positions.view(),
        molecule.calculator.n_orbs,
        &molecule.calculator.valorbs,
        molecule.proximity_matrix.view(),
        &molecule.calculator.skt,
        &molecule.calculator.orbital_energies,
    );
    assert!(grad_s.abs_diff_eq(&gradS_ref, 1e-16));
    assert!(grad_h0.abs_diff_eq(&gradH0_ref, 1e-16));
}